---
bookCollapseSection: false
summary: U-Boot is what is picked up by the T31's mircocode upon you guessed it boot ... i.e. when the chip powers on, it reaches out to several devices such as SPI Flash memory, SD controllers, and USB hunting for something that it can load into memory to bring the system to life. In PC terms this is generally handled by the BIOS. UBoot handles both primary and secondary boot stages of the system.
---

# Summary
U-Boot is what is picked up by the T31's mircocode upon you guessed it boot ... i.e. when the chip powers on, it reaches out to several devices such as SPI Flash memory, SD controllers, and USB hunting for something that it can load into memory to bring the system to life. In PC terms this is generally handled by the BIOS. UBoot handles both primary and secondary boot stages of the system.

# What is U-Boot?
Das U-Boot is an open-source, primary boot loader used in embedded devices to package the instructions to boot the device's operating system kernel.

# Compiling U-Boot

u-boot can be compiled independantly without relying on other code. THe board configuration file of T31 u-boot is located in `include/configs/isvp_t31.h`. The deault compliation configuration file is introduced in Table 3-1.

---------------------------------------------------------------------
| Chip model | Compliation File                       | Boot method |
|------------|----------------------------------------|--------------
| T31N       | `make isvp_t31_sfcnor`                 | NOR flash   |
| T31L       | `make isvp_t31_sfcnor_lite`            | NOR flash   |
| **T31X**   | `make isvp_t31_sfcnor_ddr128M`         | NOR flash   |
| T31A       | `make isvp_t31a_sfcnor_ddr128M`        | NOR flash   |
| T31N       | `make isvp_t31_msc0`                   | SD card     |
| T31L       | `make isvp_t31_msc0_lite`              | SD card     |
| **T31X**   | `make isvp_t31_msc0_ddr128M`           | SD card     |
| T31A       | `make isvp_t31a_msc0_ddr128`           | SD card     |
---------------------------------------------------------------------

## Compilation

### Step 1 - clear the old configuration
```
make distclean
```

### Step 2 - compile
{{< hint info>}}
Make sure to use the corresponding configuration per Table 3-1
{{< /hint >}}


The command to compile for T31X booting off the NOR flash, use the following:
```
make isvp_t31_sfcnor_ddr128M
```

outputs the file `uboot-with-spl.bin`

## Common modifications in the Uboot configuration file

### CONFIG_BOOTARGS
The main modification points are the memory configuration and partition size configuration after the kernel is started.
{{< hint >}}
Note: `mem` means the reserved memory after the kernel is started, and `rmem` means the memory reserved for SDK (including the memory of the ISP module); the sum of the two is the real memory size of the chip; the specific size can refer to the code).
{{< /hint >}}

### CONFIG_BOOTCOMMAND
configure the command executed by uboot. For example: in the norflash bood mode, add the command to boot from the sd card change
`"sf probe;sf read 0x80600000 0x40000 0x280000; bootm 0x80600000"` to `"mmc read 0x80600000 0x1800 0x3000; bootm 0x80600000"`.

### CONFIG_BOOTDELAY
Configure the waiting time of uboot

### NOR flash chip support
Need to add new norflash chip support

### Password
Add password function in uboot
1. Modify the configuration file `isvp_t31.h` and add the following
```
#define CONFIG_AUTOBOOT_KEYED // Mandatory
#define CONFIG_AUTOBOOT_STOP_STR "123456" // Mandatory, the password set by uboot
#define CONFIG_AUTOBOOT_PROMPT "Press xxx in %d seconds" // boot delay, optional
#define CONFIG_AUTOBOOT_DELAY_STR "linux" // Optional, 
```

the specific implementation of uboot prompt informatoin code is in `common/main.c abortboot_keyed(int bootdelay);` can be modified according to your needs.

### SD Card Upgrade Problem
Add `#define CONFIG_AUTO_UPDATE` definition in `isvp_t31.h`. The specific code is implemented in `common/cmd_sdupdate.c` Points to note: `LOAD_ADDR` 
indicates the location where the corresponding memory on the SD card is loaded into the memory. The default setting in the program is `0x82000000`. Since the address is located on the uboot heap, the common uboot heap size is set in the `CONFIG_SYS_MALLOC_LEN` appropriately) 

### Size of compiled uboot is larger than the limit
The size of the compiled uboot is larger than the limit. The default limit in the uboot code is 26Kbytes for spl part and 214Kbytes for the uboot part; a total size limit of 240Kbytes.

If the u-boot-with-spl.bin file generated by uboot compilation is larger than 240Kbytes, it connot be started.

#### Solution 1 - Increase the size limit of uboot
Increase the limit of uboot; modify the deginition of the `CONFIG_SYS_MONITOR_LEN` macro in isvp_t31.h; at the same time Modify the size of the boot partition and the offset addresses of subsequent partitions in the CONFIG_BOOTARGS cariable

#### Solution 2 - Compress UBoot
If the generated u-boot-with-spl.bin exceeds 240Kbytes, you can compress uboot.
Modify `#undef CONFIG_SPL_LZOP` to `#define CONFIG_SPL_LZOP` in isvp_t31.h; then recompile the burned file name u-boot-lzo-with-spl.bin

### Uboot Network problem
Uboot network problem The default isvp configuration is the code that includes the Ethernet part, if the product does not need TFTP in the uboot stage ... Mounting or NFS mounting, you can cut out the Ethernet part of the code to reduce the size of uboot.

To leave Ethernet out of the compiled output open the isvp_T31.h configuration file and comment out the `#define CONFIG_CMD_NET` macro.
